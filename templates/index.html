{% extends 'layout.html' %}
{% load static %}
{% block title %}Exotic Pet Shop{% endblock %}
{% block content %}
<link rel="stylesheet" type="text/css" href="{% static '/css/index.css' %}">
<main class="flex-grow container my-4">
    <!-- Left Sidebar (Categories) -->
    <div class="sidebar sidebar-left">
        <h3>Categories</h3>
        <ul>
            <li>
                <a href="#" class="parent-category active" data-category-id="all">All Animals</a>
            </li>
            {% for category in categories %}
            <li>
                <a href="#" class="parent-category" data-category-id="{{ category.id }}">{{ category.name }}</a>
                {% if category.category_set.all %}
                <ul class="child-categories" id="children-{{ category.id }}">
                    {% for subcategory in category.category_set.all %}
                    <li class="child-category">
                        <a href="#" data-category-id="{{ subcategory.id }}" data-parent-id="{{ category.id }}">{{ subcategory.name }}</a>
                    </li>
                    {% endfor %}
                </ul>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
    </div>

    <section class="mb-5">
        <h1 class="display-4 font-weight-bold mb-4">Welcome to Exotic Pet Shop</h1>
        <p class="lead">Discover the perfect companion from our wide selection of exotic pets.</p>
    </section>

    <!-- Animal list -->
    <section>
        <div class="bg-warning p-4 rounded-top" style="opacity: 90%">
            <h2 class="h3 font-weight-bold">Featured Animals</h2>
        </div>
        <div class="bg-warning p-4 rounded-bottom">
            <div class="row">
                {% for animal in animals %}
                <a href="{% url 'Store:animal_details' animal.id %}">
                    <div class="col-4 col-md-4 col-lg-2 mb-4 category-card" data-category="{{ animal.category.id }}" data-parent-category="{{ animal.category.parent.id|default:animal.category.id }}">
                        <div class="card h-100" style="background-color: rgb(24, 26, 27)">
                            <img src="{{ animal.image.url }}" class="card-img-top" alt="{{ animal.common_name }}">
                            <div class="card-body text-center">
                                <h5 class="card-title text-white">{{ animal.common_name }}</h5>
                                <p>{{ animal.price|floatformat:"-1" }} â‚¬</p>
                                <a href="#" class="btn btn-warning text-white hover-bg-orange" data-bs-toggle="modal" data-bs-target="#addToCartModal" data-animal-id="{{ animal.id }}">Add to Cart</a>
                            </div>
                        </div>
                    </div>
                </a>
                {% endfor %}
            </div>
            <button class="btn btn-dark text-warning font-weight-bold" id="toggle-button">View All {{ animal_count }} Animals</button>
        </div>
    </section>

    <!-- Modal -->
    <div class="modal fade" id="addToCartModal" tabindex="-1" aria-labelledby="addToCartModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addToCartModalLabel">Add to Cart</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addToCartForm" method="POST">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="quantity" class="form-label">Quantity</label>
                            <input type="number" class="form-control" id="quantity" name="quantity" min="1" value="1">
                        </div>
                        <div class="mb-3">
                            <label for="age" class="form-label">Age</label>
                            <input type="number" class="form-control" id="age" name="age" min="1" value="1">
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Add to Cart</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Sidebar (Cart) -->
    <div class="sidebar sidebar-right">
        <h3>Your Cart</h3>
        <div id="cart-items">
            {% for cart_item in cart_items %}
            <div class="cart-item" data-price="{{ cart_item.animal.price }}">
                <button class="cart-item-remove">&times;</button>
                <div class="cart-item-name">{{ cart_item.animal.common_name }}</div>
                <div class="cart-item-details">
                    <div class="cart-item-quantity">
                        <button class="quantity-decrease">-</button>
                        <input type="number" value="{{ cart_item.quantity }}" min="1" max="99" class="quantity-input" readonly>
                        <button class="quantity-increase">+</button>
                    </div>
                    <div class="cart-item-row">
                        <span class="cart-item-label">Age:</span>
                        <select id="age" name="age">
                            <option value="{{ cart_item.age }}" selected>{{ cart_item.age }} year{% if cart_item.age != 1 %}s{% endif %}</option>
                        </select>
                    </div>
                    <div class="cart-item-row">
                        <span class="cart-item-label">Sex:</span>
                        <select id="sex" name="sex">
                            <option value="M" {% if cart_item.sex == "M" %}selected{% endif %}>Male</option>
                            <option value="F" {% if cart_item.sex == "F" %}selected{% endif %}>Female</option>
                        </select>
                    </div>
                </div>
                <div class="cart-item-price">${{ cart_item.total_price|floatformat:2 }}</div>
            </div>
            {% empty %}
            <p>Your cart is empty.</p>
            {% endfor %}
        </div>
        <div class="cart-total">
            Total: ${{ cart.total_price|default:0|floatformat:2 }}
        </div>
    </div>

    <section class="mt-5">
        <h2 class="h3 font-weight-bold mb-4">Why Choose Us?</h2>
        <div class="row">
            <div class="col-md-4 mb-4">
                <div class="bg-secondary p-4 rounded">
                    <h3 class="h5 font-weight-bold">Expert Care</h3>
                    <p>Our team of experienced professionals ensures the health and well-being of all our animals.</p>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="bg-secondary p-4 rounded">
                    <h3 class="h5 font-weight-bold">Wide Selection</h3>
                    <p>From reptiles to amphibians, we offer a diverse range of exotic pets to suit every preference.</p>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="bg-secondary p-4 rounded">
                    <h3 class="h5 font-weight-bold">Education First</h3>
                    <p>We provide comprehensive care guides and support to ensure you can properly care for your new pet.</p>
                </div>
            </div>
        </div>
    </section>
</main>
    

<script>
    // Collapsible categories
    document.addEventListener('DOMContentLoaded', function() {
        var parentCategories = document.querySelectorAll('.parent-category');
    
        parentCategories.forEach(function(parent) {
            parent.addEventListener('click', function(event) {
                event.preventDefault();
    
                // Toggle the 'open' class on the clicked parent
                this.classList.toggle('open');
    
                var categoryId = this.getAttribute('data-category-id');
                var childCategories = document.getElementById('children-' + categoryId);
    
                if (childCategories) {
                    childCategories.classList.toggle('show');
                }
            });
        });
    });
</script>

<script>
    // Get all "Add to Cart" buttons
    var addToCartButtons = document.querySelectorAll('[data-bs-toggle="modal"][data-bs-target="#addToCartModal"]');

    // Add click event listener to each button
    addToCartButtons.forEach(function(button) {
        button.addEventListener('click', function(event) {
            // Prevent default behavior
            event.preventDefault();

            // Extract animal ID from data-* attributes
            var animalId = button.getAttribute('data-animal-id');

            // Update the form action
            var form = document.getElementById('addToCartForm');
            form.action = "{% url 'Store:add_to_cart' animal_id=999999 %}".replace('999999', animalId);

            // Show the modal
            var modal = new bootstrap.Modal(document.getElementById('addToCartModal'));
            modal.show();
        });
    });
</script>

<script>
    //3D Tilt effect on cards hover
    document.addEventListener('DOMContentLoaded', function() {
        const cards = document.querySelectorAll('.category-card .card');

        cards.forEach(card => {
            card.addEventListener('mousemove', handleMouseMove);
            card.addEventListener('mouseleave', handleMouseLeave);
        });

        function handleMouseMove(e) {
            const card = this;
            const cardRect = card.getBoundingClientRect();
            const cardCenterX = cardRect.left + cardRect.width / 2;
            const cardCenterY = cardRect.top + cardRect.height / 2;
            const mouseX = e.clientX - cardCenterX;
            const mouseY = e.clientY - cardCenterY;
            const rotateY = (mouseX / cardRect.width) * 20;
            const rotateX = -(mouseY / cardRect.height) * 20;

            card.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.05)`;
        }

        function handleMouseLeave(e) {
            this.style.transform = 'rotateX(0) rotateY(0) scale(1)';
        }
    });
</script>

<script>
    // Filter animals by category
    document.addEventListener('DOMContentLoaded', function() {
        const categoryLinks = document.querySelectorAll('.sidebar-left a');
        const animalCards = document.querySelectorAll('.category-card');
        const toggleButton = document.getElementById('toggle-button');
    
        const animationDuration = 400; // in milliseconds
        const delayBetweenCards = 20; // in milliseconds
    
        let currentCategory = 'all';
        let visibleCards = [];
    
        categoryLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const categoryId = this.getAttribute('data-category-id');
                const parentId = this.getAttribute('data-parent-id');
    
                categoryLinks.forEach(l => l.classList.remove('active'));
                this.classList.add('active');
    
                currentCategory = categoryId;
                filterAnimals(categoryId, parentId);
            });
        });
    
        function filterAnimals(categoryId, parentId) {
            visibleCards = [];
            let visibleCardIndex = 0;
    
            animalCards.forEach((card) => {
                const cardCategory = card.getAttribute('data-category');
                const cardParentCategory = card.getAttribute('data-parent-category');
    
                card.style.opacity = '0';
                card.style.transform = 'translateX(-20px)';
                card.style.display = 'none';
    
                if (categoryId === 'all' ||
                    cardCategory === categoryId ||
                    cardParentCategory === categoryId) {
                    visibleCards.push(card);
                    showCard(card, visibleCardIndex);
                    visibleCardIndex++;
                }
            });
    
            updateToggleButton();
        }
        
        // Animation that goes through every card
        function showCard(card, index) {
            card.style.display = 'block';
            setTimeout(() => {
                card.style.transition = `opacity ${animationDuration}ms ease, transform ${animationDuration}ms ease`;
                card.style.opacity = '1';
                card.style.transform = 'translateX(0)';
            }, index * delayBetweenCards);
        }
        
        // Logic for the View button
        function updateToggleButton() {
            if (visibleCards.length > 12) {
                toggleButton.style.display = 'block';
                toggleButton.textContent = 'View Less';
            } else {
                toggleButton.style.display = 'none';
            }
        }
            
        toggleButton.addEventListener('click', function() {
            if (this.textContent === 'View Less') {
                visibleCards.forEach((card, index) => {
                    if (index >= 12) {
                        card.style.display = 'none';
                    }
                });
                this.textContent = `View All ${visibleCards.length} Animals`;
            } else {
                visibleCards.forEach((card, index) => showCard(card, index));
                this.textContent = 'View Less';
            }
        });
    
        // Initial filter
        filterAnimals('all');
    });
</script>
{% endblock %}
